<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mi repertorio</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <style>
    body { background: #202f80; color: #f7f7f7; }
    .app-shell { max-width: 900px; }
    .panel { background: rgba(255,255,255,0.08); border-radius: 12px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); }
    table { background: #f9f9f9; color: #1d1d1d; }
    .table thead { background: #303b8c; color: #f7f7f7; }
    .table tbody tr:nth-child(odd) { background: #f4f4f4; }
    .icon { filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2)); }
    label { color: #e2e6ff; }
    .btn-success { background: #28a745; border-color: #28a745; }
    .table td, .table th { vertical-align: middle; }
  </style>
</head>
<body class="min-vh-100 d-flex flex-column">
  <div class="container py-4 flex-grow-1 app-shell">
    <h1 class="text-center mb-4">&#119070; Mi repertorio &#119070;</h1>
    <div id="status" class="alert alert-warning d-none" role="alert"></div>
    <div class="panel mb-4">
      <form id="song-form" class="row g-3">
        <div class="col-12">
          <label for="titulo" class="form-label">Canción</label>
          <input id="titulo" name="titulo" class="form-control" placeholder="Título" required />
        </div>
        <div class="col-12">
          <label for="artista" class="form-label">Artista</label>
          <input id="artista" name="artista" class="form-control" placeholder="Artista" required />
        </div>
        <div class="col-12">
          <label for="tono" class="form-label">Tono</label>
          <input id="tono" name="tono" class="form-control" placeholder="Ej: Dm" required />
        </div>
        <div class="col-12 text-center">
          <button class="btn btn-success" type="submit">Agregar</button>
        </div>
      </form>
    </div>
    <div class="panel">
      <div class="d-flex align-items-center justify-content-center gap-2 mb-3 text-center">
        <h3 class="m-0">Tabla de canciones</h3>
        <span class="icon" aria-hidden="true">&#127908;</span>
      </div>
      <div class="table-responsive">
        <table class="table align-middle" id="songs-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Canción</th>
              <th>Artista</th>
              <th>Tono</th>
              <th class="text-center">Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById('song-form');
    const tbody = document.querySelector('#songs-table tbody');
    const status = document.getElementById('status');

    function showStatus(message, type = 'warning') {
      status.textContent = message;
      status.className = `alert alert-${type}`;
      status.classList.remove('d-none');
    }

    function clearStatus() {
      status.classList.add('d-none');
      status.textContent = '';
    }

    let songsState = [];
    const BASE_URL = window.location.origin && window.location.origin.startsWith('http') && window.location.origin !== 'null'
      ? window.location.origin
      : 'http://localhost:3000';
    const endpoint = (path) => `${BASE_URL}${path}`;

    const api = {
      async list() {
        const res = await fetch(endpoint('/canciones'));
        if (!res.ok) throw new Error('No se pudo leer el repertorio');
        return res.json();
      },
      async create(data) {
        const res = await fetch(endpoint('/canciones'), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (!res.ok) throw new Error('No se pudo agregar la canción');
        return res.json();
      },
      async update(id, data) {
        const res = await fetch(endpoint(`/canciones/${id}`), {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (!res.ok) throw new Error('No se pudo editar la canción');
        return res.json();
      },
      async remove(id) {
        const res = await fetch(endpoint(`/canciones/${id}`), { method: 'DELETE' });
        if (!res.ok) throw new Error('No se pudo eliminar la canción');
        return res.json();
      }
    };

    function renderRow(song, index) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${index + 1}</td>
        <td>${song.titulo}</td>
        <td>${song.artista}</td>
        <td>${song.tono}</td>
        <td class="text-center">
          <button class="btn btn-warning btn-sm me-2">Editar</button>
          <button class="btn btn-danger btn-sm">Eliminar</button>
        </td>`;

      tr.querySelector('.btn-warning').addEventListener('click', async () => {
        const titulo = prompt('Nuevo título', song.titulo);
        const artista = prompt('Nuevo artista', song.artista);
        const tono = prompt('Nuevo tono', song.tono);
        if (!titulo || !artista || !tono) return;
        await api.update(song.id, { titulo, artista, tono });
        await refresh();
      });

      tr.querySelector('.btn-danger').addEventListener('click', async () => {
        if (!confirm('¿Eliminar canción?')) return;
        await api.remove(song.id);
        await refresh();
      });

      return tr;
    }

    async function refresh() {
      clearStatus();
      try {
        songsState = await api.list();
        tbody.innerHTML = '';
        songsState.forEach((song, idx) => tbody.appendChild(renderRow(song, idx)));
      } catch (err) {
        showStatus(err.message || 'Error cargando repertorio', 'danger');
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearStatus();
      const data = {
        titulo: form.titulo.value.trim(),
        artista: form.artista.value.trim(),
        tono: form.tono.value.trim()
      };
      if (!data.titulo || !data.artista || !data.tono) {
        showStatus('Completa todos los campos.', 'info');
        return;
      }
      try {
        const created = await api.create(data);
        songsState.push(created);
        tbody.appendChild(renderRow(created, songsState.length - 1));
        form.reset();
        showStatus('Canción agregada con éxito.', 'success');
      } catch (err) {
        showStatus(err.message || 'No se pudo agregar la canción', 'danger');
      }
    });

    refresh();
  </script>
</body>
</html>
